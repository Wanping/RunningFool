{"version":3,"sources":["assets\\script\\utils\\wechatSdk.js"],"names":["singleton","require","eventCenter","eventDef","cc","Class","Component","ctor","console","log","isWeChat","userInfo","userInfoCallback","wxSessionVaild","checkWxSession","initLoginButton","sys","browserType","BROWSER_TYPE_WECHAT_GAME","wx","checkSession","success","fail","login","successFunc","getUserInfo","self","window","sysInfo","getSystemInfoSync","width","screenWidth","height","screenHeight","getSetting","res","authSetting","button","createUserInfoButton","type","text","style","left","top","backgroundColor","color","fontSize","textAlign","lineHeight","onTap","userData","setUserWxData","emitEvent","PreloadScene","destroy","JSON","stringify"],"mappings":"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","sourceRoot":"/","sourcesContent":["let singleton = require(\"singleton\");\r\nlet eventCenter = require(\"eventCenter\");\r\nlet eventDef = require(\"eventDef\");\r\n\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    ctor() {\r\n        console.log(\"wechatSdk ctor\");\r\n\r\n        if (!this.isWeChat()) {\r\n            console.log(\"The env isn't wechat\");\r\n            return;\r\n        }\r\n\r\n        this.userInfo = null;\r\n        this.userInfoCallback = null;\r\n        this.wxSessionVaild = this.checkWxSession();\r\n        this.initLoginButton();\r\n    },\r\n\r\n    // 判断是否是wx\r\n    isWeChat() {\r\n        return cc.sys.browserType === cc.sys.BROWSER_TYPE_WECHAT_GAME;\r\n    },\r\n\r\n    // 判断Session是否过期\r\n    checkWxSession() {\r\n        wx.checkSession({\r\n            success() {\r\n                //session_key 未过期，并且在本生命周期一直有效\r\n                return true;\r\n            },\r\n            fail() {\r\n                // session_key 已经失效，需要重新执行登录流程\r\n                return false;\r\n            }\r\n        })\r\n    },\r\n\r\n    // 登录\r\n    login () {\r\n        console.log(\"wechatSdk login..\");\r\n        this.successFunc = successFunc;\r\n        if (this.wxSessionVaild) {\r\n            this.getUserInfo();\r\n        }\r\n    },\r\n\r\n    // 初始化授权按钮\r\n    initLoginButton() {\r\n        let self = this;\r\n        let wx = window['wx'];\r\n        let sysInfo = wx.getSystemInfoSync();\r\n        let width = sysInfo.screenWidth;\r\n        let height = sysInfo.screenHeight;\r\n        wx.getSetting({\r\n            success(res) {\r\n                console.log(\"UserAuthSetting: \" + res.authSetting);\r\n                if (res.authSetting[\"scope.userInfo\"]) {\r\n                    console.log(\"The user has the scope!\");\r\n                    self.getUserInfo();\r\n                } else {\r\n                    console.log(\"The user hasn't the scope!\");\r\n                    let button = wx.createUserInfoButton({\r\n                        type: 'text',\r\n                        text: '',\r\n                        style: {\r\n                            left: width / 2,\r\n                            top: height / 2,\r\n                            width: width,\r\n                            height: height,\r\n                            backgroundColor: '#00000000',\r\n                            color: '#ffffff',\r\n                            fontSize: 20,\r\n                            textAlign: \"center\",\r\n                            lineHeight: height,\r\n                        }\r\n                        // 授权按钮全屏\r\n                    });\r\n                    button.onTap(function (res) {\r\n                        if (res.userInfo) {\r\n                            self.userInfo = res.userInfo;\r\n                            singleton.userData.setUserWxData(self.userInfo);\r\n                            eventCenter.emitEvent(eventDef.PreloadScene);\r\n                            button.destroy();\r\n                        } else {\r\n                            console.log(\"The user cncelled the authorization!\");\r\n                        }\r\n                    })\r\n                }\r\n            }\r\n        })\r\n    },\r\n\r\n    // 获取用户信息\r\n    getUserInfo() {\r\n        let self = this;\r\n        wx.getUserInfo({\r\n            success(res) {\r\n                console.log(\"The userInfo is \" + JSON.stringify(res.userInfo));\r\n                self.userInfo = res.userInfo;\r\n                singleton.userData.setUserWxData(self.userInfo);\r\n                eventCenter.emitEvent(eventDef.PreloadScene);\r\n            }\r\n        });\r\n    },\r\n});\r\n"]}